---
slug: "cors-amazon-cloudfront-s3"
title: "CORS - Amazon CloudFront & S3"
description: "Amazon предоставляет большой выбор веб-сервисов, которые мы можем дружить друг с другом, тем самым улучшая свой продукт. Сегодня я расскажу про CloudFront и S3, а также, как решить проблему с CORS."
summary: "Amazon предоставляет большой выбор веб-сервисов, которые мы можем дружить друг с другом, тем самым улучшая свой продукт. Сегодня я расскажу про CloudFront и S3, а также, как решить проблему с CORS."
image: "/images/posts/cors-s3.jpg"
date: 2022-08-13
tags: [cors amazon cloudfront s3]
---

![CORS - Amazon CloudFront & S3](/images/posts/cors-s3.jpg "CORS - Amazon CloudFront & S3")

### Приступим
Amazon предоставляет большой выбор веб-сервисов, которые мы можем дружить друг с другом, тем самым улучшая свой продукт. 
Сегодня я расскажу про _CloudFront_ и _S3_, а также, как решить проблему с _CORS_.

- _Amazon CloudFront_ – это сервис сети доставки контента (CDN), созданный для высокой производительности, безопасности и удобства разработчиков. Входящие в состав CDN cерверы географически располагаются таким образом, чтобы сделать время ответа для пользователей сайта/сервиса минимальным.

- _Amazon Simple Storage Service (Amazon S3)_ – это сервис, позволяющий хранить файлы любого типа и объема. Чаще всего его используют для хранения неструктурированных данных: изображений, видео, архивов документов и т.д.

- _Cross-Origin Resource Sharing (CORS)_ –  технология, которая позволяет предоставить веб-страницам доступ к ресурсам другого домена.

### Проблема
У нас есть веб-приложение, в которое мы решили добавить шрифт/картинку/стили, что угодно и разместили этот файл в своем бакете на S3. Получили ссылку вида _cdn.mysite.com_, прописали в _header_, обновили страницу и... увы, ничего не работает.

```sh
Access to font at 'https://cdn.mysite.com/assets/font.woff2' from origin 'https://mysite.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

##### Подводные камни

В гугле можно найти много возможных решений, но, к сожалению, по комментариям понимаем, что это работает через раз. Все усложняется устаревшими примерами _CORS_ политик в _YAML_ формате или интерфейса _Amazon_.

Обновление занимает от 20 минут до часу, поэтому возникает вероятность, что вы не дождетесь обновления и пойдете менять конфиги и, как самый худший сценарий - сломаете верный конфиг в ходе экспериментов.

Не все браузеры отображают данную ошибку, например _Safari_ наотрез игнорировал, что что-то не так, а _Chrome_ наоборот засыпал консоль красным текстом.

### Решаем проблему

Первым делом нужно перейти в консоль _Amazon S3_, открыть нужный бакет и перейти на вкладку _Permissions_, спуститься вниз страницы до _Cross-origin resource sharing (CORS)_, нажать кнопку _Edit_ и прописать такой конфиг:
```json
[
  {
     "AllowedHeaders": [ "*" ], # можем указать спискок доменов, которые не будем блокировать
     "AllowedMethods": [ "HEAD", "GET" ],
     "AllowedOrigins": [ "*" ],
     "ExposeHeaders": [],
     "MaxAgeSeconds": 3000
  }
]
```

Теперь настроим правила для _Amazon CloudFront_, переходим в консоль, выбираем _Distributions_, выбираем наш _cdn_, проваливаемся внутрь, нажимаем на таб _Behaviors_ и редактируем (можно выбрать _Default (*)_).

![CORS - Amazon CloudFront & S3](/images/posts/cors-s3-1.png "CORS - Amazon CloudFront & S3")